<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Conqueror Demo</title>

        <script src="/socket.io/socket.io.js"></script>
        <script src="bower_components/webrtc-adapter/adapter.js"></script>
        <script src="bower_components/kurento-utils/js/kurento-utils.js"></script>
    </head>

    <body>
        <div>
            <p>Input: <video id="input_video" autoplay controls muted></video></p>
            <p>Output: <video id="output_video" autoplay controls></video></p>
        </div>
        <label>Username: <input id="username" value="Kido"></label>
        <p><strong>Session id: <span id="session_id">Not yet received</span></strong></p>
        <p><strong>Status: <span id="status">No connection</span></strong></p>
        <button id="create_call">Create Call</button><hr>
        <label>Call ID: <input id="call_id" value="" placeholder="Call id to join"></label>
        <button id="join_call">Join Call</button>
        <script>
         var pclocal,
             localstream,
             localdesc,
             sdpanswer;

         window.addEventListener("DOMContentLoaded", function () {
             var socket = io(),
                 localvideo = document.querySelector("#input_video"),
                 remotevideo = document.querySelector("#output_video"),
                 callbtn = document.querySelector("#create_call"),
                 sessionspan = document.querySelector("#session_id"),
                 statusspan = document.querySelector("#status"),
                 nameinput = document.querySelector("#username"),
                 callidinput = document.querySelector("#call_id"),
                 joinbtn = document.querySelector("#join_call");

             var calltype = "CREATE";

             socket.on("message", function (message) {
                 if (message.type) {
                     switch (message.type) {
                         case "CONNECTION":
                             statusspan.innerHTML = "Connected to server";
                             break;
                         case "STATUS":
                             statusspan.innerHTML = message.value;
                             break;
                         default:
                             statusspan.innerHTML = "No connection";
                     }
                 }
             });

             callbtn.addEventListener("click", createcall, false);

             joinbtn.addEventListener("click", joincall, false);

             function createcall () {
                 calltype = "CREATE";
                 callbtn.setAttribute("disabled", "disabled");
                 joinbtn.setAttribute("disabled", "disabled");
                 console.log("Starting call");
                 initiate();
             }

             function joincall () {
                 calltype = "JOIN";
                 callbtn.setAttribute("disabled", "disabled");
                 joinbtn.setAttribute("disabled", "disabled");
                 console.log("Starting call");
                 initiate();
             }

             function initiate() {
                 pclocal = kurentoUtils.WebRtcPeer.startSendRecv(localvideo, remotevideo, gotLocalDescription,
                                                                 onerror, { audio: true, video: false });
             }

             function gotLocalDescription (desc) {
                 localdesc = desc;
                 console.log("Local description set. Connecting to conqueror...");
                 switch (calltype) {
                     case "CREATE":
                         socket.emit("call:create", { name: nameinput.value, sdpOffer: localdesc },
                                     socketcallback);
                         break;
                     case "JOIN":
                         socket.emit("call:connect", {
                             name: nameinput.value,
                             sdpOffer: localdesc,
                             sessionid: callidinput.value.trim()
                         }, socketcallback);
                         break;
                     }
             }

             function socketcallback (err, val) {
                 if (err) {
                     statusspan.innerHTML = "ERROR: " + err.message;
                     console.error(err);
                     return;
                 }
                 sdpanswer = val.session.sdpAnswer;
                 sessionspan.innerHTML = val.session.id;
                 pclocal.processSdpAnswer(sdpanswer);
             };

             function onerror (e) {
                 console.error("Error", e);
            }
         });
        </script>
    </body>

</html>
